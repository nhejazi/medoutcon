---
title: "Efficient causal mediation analysis with intermediate confounders"
author: "[Nima Hejazi](https://nimahejazi.org), [Iván
  Díaz](https://www.idiaz.xyz/), and [Kara
  Rudolph](https://kararudolph.github.io/)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: ../inst/REFERENCES.bib
vignette: >
  %\VignetteIndexEntry{Efficient causal mediation analysis with intermediate confounders}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Background and Motivations

An exposure of interest often affects an outcome directly, or indirectly by the
mediation of some intermediate variables. Identifying and quantifying the
mechanisms underlying causal effects is an increasingly popular endeavor in
public health, medicine, and the social sciences, as knowledge of such
mechanisms can improve understanding of both _why and how_ treatments can be
effective. Such mechanistic knowledge may be arguably even more important in
cases where treatments result in unanticipated ineffective or even harmful
effects.

Traditional techniques for mediation analysis fare poorly in the face of
intermediate confounding. Classical parameters like the natural (in)direct
effects face a lack of identifiability in cases where mediator-outcome (i.e.,
intermediate) confounders affected by exposure complicate the relationship
between the exposure, mediators, and outcome. @diaz2020nonparametric provide a
theoretical and computational study of the properties of newly developed
interventional (in)direct effect estimands within the non-parametric statistical
model. Among their contributions, @diaz2020nonparametric
- derive the efficient influence function (EIF), an key object in
  semiparametric efficiency theory;
- use the EIF to develop two asymptotically optimal, non-parametric estimators,
  each of which is capable of leveraging machine learning for the estimation of
  nuisance parameters; and
- present theoretical conditions under which their proposed estimators are
  consistent, multiply robust, and efficient.

# Problem Setup and Notation

The problem addressed by the work of @diaz2020nonparametric may be represented
by the following nonparametric structural equation model (NPSEM):
\begin{align*}
  W &= f_W(U_W); A = f_A(W, U_A); Z=f_Z(W, A, U_Z);\\ \nonumber
  M &= f_M(W, A, Z, U_M); Y = f_Y(W, A, Z, M, U_Y).
\end{align*}
In the NPSEM, $W$ denotes a vector of observed pre-treatment covariates, $A$
denotes a categorical treatment variable, $Z$ denotes an intermediate confounder
affected by treatment, $M$ denotes a (possibly multivariate) mediator, and $Y$
denotes a continuous or binary outcome.  The vector of exogenous factors
$U=(U_W,U_A,U_Z,U_M,U_Y)$, and the functions $f$, are assumed deterministic but
unknown.  Importantly, the NPSEM encodes a time-ordering between these variables
and allows the evaluation of counterfactual quantities defined by intervening on
a set of nodes of the NPSEM.  The observed data unit can be represented by the
random variable $O = (W, A, Z, M, Y)$; we consider access to $O_1, \ldots, O_n$,
a sample of $n$ i.i.d.~observations of $O$.

@diaz2020nonparametric additionally define the following parameterizations,
familiarity with which will be useful for using the [`medoutcon` `R`
package](https://github.com/nhejazi/medoutcon). In particular, these authors
define $\g(a \mid w)$ as the probability mass function of $A = a$ conditional on
$W = w$ and use $\e(a \mid m, w)$ to denote the probability mass function of $A
= a$ conditional on $(M, W) = (m, w)$. Further, @diaz2020nonparametric use
$\m(a, z, m, w)$ to denote the outcome regression function $\mathbb{E}(Y \mid A
= a, Z = z, M = m, W = w)$, as well as $q(z \mid a,w)$ and $r(z \mid a, m, w)$
to denote the corresponding conditional densities of $Z$.

# Interventional (In)Direct Effects

@diaz2020nonparametric define the _total effect_ of $A$ on $Y$ in terms of a
contrast between two user-supplied values $a', a^{\star} \in \mathcal{A}$.
Examination of the NPSEM reveals that there are four paths involved in this
effect, namely $A \rightarrow Y$, $A \rightarrow M \rightarrow Y$, $A
\rightarrow Z \rightarrow Y$, and $A \rightarrow Z \rightarrow M \rightarrow Y$.
Mediation analysis has classically considered the _natural direct effect_ (NDE)
and the _natural indirect effect_ (NIE), which are defined as
$\mathbb{E}_c(Y_{a', M_{a^{\star}}} - Y_{a^{\star}, M_{a^{\star}}})$ and
$\mathbb{E}_c(Y_{a',M_{a'}} - Y_{a',M_{a^{\star}}})$, respectively. The natural
direct effect measures the effect through paths _not_ involving the mediator
($A\rightarrow Y$ and $A\rightarrow Z \rightarrow Y$), whereas the natural
indirect effect measures the effect through paths involving the mediator
($A\rightarrow M \rightarrow Y$ and $A\rightarrow Z \rightarrow M \rightarrow
Y$). As the sum of the natural direct and indirect effects equals the average
treatment effect $\mathbb{E}_c(Y_1-Y_0)$, this effect decomposition is
appealing. Unfortunately, the natural direct and indirect effects are
not generally identified in the presence of an intermediate confounder affected
by treatment.

To circumvent this issue, @diaz2020nonparametric define the direct and indirect
effects using stochastic interventions on the mediator, following a strategy
previously outline by @vanderweele2014effect and @rudolph2017robust, among
others. Let $G_a$ denote a random draw from the conditional distribution of
$M_a$ conditional on $W$. Consider the effect of $A$ on $Y$ defined as the
difference in expected outcome in hypothetical worlds in which $(A,M) = (a',
G_{a'})$ versus $(A,M) = (a^{\star}, G_{a^{\star}})$ with probability one, which
may be decomposed into direct and indirect effects as follows
\begin{equation*}
\mathbb{E}_c(Y_{a', G_{a'}} - Y_{a^{\star}, G_{a^{\star}}}) =
  \underbrace{\mathbb{E}_c(Y_{a', G_{a'}} - Y_{a',
    G_{a^{\star}}})}_{\text{Indirect effect (through $M$)}} +
  \underbrace{\mathbb{E}_c(Y_{a', G_{a^{\star}}} - Y_{a^{\star},
      G_{a^{\star}}})}_{\text{Direct effect (not through $M$)}}.
\end{equation*}
Like the natural direct effect, this interventional direct effect measures the
effects through paths not involving the mediator. Likewise, the interventional
indirect effect measures the effect through paths involving the mediator. Note,
however, that natural and interventional mediation effects have different
interpretations. That is, the interventional indirect effect measures the effect
of fixing the exposure at $a'$ while setting the mediator to a random draw
$G_{a^{\star}}$ from those with exposure $a'$ versus a random draw $G_{a'}$ from
those with exposure $a^{\star}$, given covariates $W$. As is clear from the
effect decomposition, the term $\theta_c = \mathbb{E}_c(Y_{a', G_{a^{\star}}})$
is required for estimation of both the interventional direct and indirect
effects; thus, @diaz2020nonparametric focus on estimation of this quantity.
Importantly, it has been shown that $\theta_c$ is identified by the statistical
functional
\begin{equation*}
  \theta = \int m(a', z, m, w) q(z \mid a', w) p(m \mid a^{\star}, w)
  p(w) d\nu(w,z,m)
\end{equation*}
under a set of standard identifiability conditions [@vanderweele2014effect],
which are further reviewed in @diaz2020nonparametric.

# Efficient Estimation

@diaz2020nonparametric define two efficient estimators of their interventional
(in)direct effects. These are based on the one-step estimation and targeted
minimum loss (TML) estimation frameworks, respectively. Briefly, both estimation
strategies proceed in two stages, starting by first constructing initial
estimates of the nuisance parameters present in the EIF, then proceeding to
apply distinct bias-correction strategies in their second stages. Both
estimation strategies require an assumption about the behavior of initial
estimators of the nuisance parameters (specifically, that these lie in a
so-called Donsker class); however, such an assumption may be avoided by making
use of cross-validation in fitting initial estimators. Consistent with recent
theoretical developments, the `medoutcon` `R` package requires the use of
cross-validation in constructing these initial estimates.

The one-step estimator $\hat{\theta}_{text{os}}$ is constructed by adding the
empirical mean of the EIF (evaluated at initial estimates of the nuisance
parameters) to the substitution estimator. By constrast, the TML estimator
$\hat{\theta}_{\text{tmle}}$ updates the components of the substitution
estimator via logistic tilting models formulated to ensure that relevant score
equations appearing in the EIF are (approximately) solved.  While the estimators
are asymptotically equivalent, TML estimators have been shown to exhibit
superior finite-sample performance, making them potentially more reliable than
one-step estimators. For the exact form of the EIF as well as those of the
one-step and TML estimators, consult @diaz2020nonparametric.

# Data Analysis Example

## Setting up the data example

[TO FILL IN]

```{r setup, message=FALSE, warning=FALSE}
library(data.table)
library(tidyverse)
library(medoutcon)
set.seed(75681)
```

```{r example_data, message=FALSE, warning=FALSE}
# produces a simple data set based on ca causal model with mediation
make_example_data <- function(n_obs = 1000) {
  ## baseline covariates
  w_1 <- rbinom(n_obs, 1, prob = 0.6)
  w_2 <- rbinom(n_obs, 1, prob = 0.3)
  w_3 <- rbinom(n_obs, 1, prob = pmin(0.2 + (w_1 + w_2) / 3, 1))
  w <- cbind(w_1, w_2, w_3)
  w_names <- paste("W", seq_len(ncol(w)), sep = "_")

  ## exposure
  a <- as.numeric(rbinom(n_obs, 1, plogis(rowSums(w) - 2)))

  ## mediator-outcome confounder affected by treatment
  z <- rbinom(n_obs, 1, plogis(rowMeans(-log(2) + w - a) + 0.2))

  ## mediator -- could be multivariate
  m <- rbinom(n_obs, 1, plogis(rowSums(log(3) * w[, -3] + a - z)))
  m_names <- "M"

  ## outcome
  y <- rbinom(n_obs, 1, plogis(1 / (rowSums(w) - z + a + m)))

  ## construct output
  dat <- as.data.table(cbind(w = w, a = a, z = z, m = m, y = y))
  setnames(dat, c(w_names, "A", "Z", m_names, "Y"))
  return(dat)
}

# set seed and simulate example data
example_data <- make_example_data()
w_names <- str_subset(colnames(example_data), "w")
m_names <- str_subset(colnames(example_data), "m")

# quick look at the data
head(example_data)
```

[TO FILL IN]

## Estimating the direct effect

```{r de_os, eval=FALSE, message=FALSE, warning=FALSE}
# compute one-step estimate of the interventional direct effect
os_de <- medoutcon(W = example_data[, ..w_names],
                   A = example_data$A,
                   Z = example_data$Z,
                   M = example_data[, ..m_names],
                   Y = example_data$Y,
                   effect = "direct",
                   estimator = "onestep")
summary(os_de)
```

[TO FILL IN]


```{r de_tmle, eval=FALSE, message=FALSE, warning=FALSE}
# compute targeted minimum loss estimate of the interventional direct effect
tmle_de <- medoutcon(W = example_data[, ..w_names],
                     A = example_data$A,
                     Z = example_data$Z,
                     M = example_data[, ..m_names],
                     Y = example_data$Y,
                     effect = "direct",
                     estimator = "tmle")
summary(tmle_de)
```

[TO FILL IN]

## Estimating the indirect effect

```{r ie_os, eval=FALSE, message=FALSE, warning=FALSE}
# compute one-step estimate of the interventional indirect effect
os_ie <- medoutcon(W = example_data[, ..w_names],
                   A = example_data$A,
                   Z = example_data$Z,
                   M = example_data[, ..m_names],
                   Y = example_data$Y,
                   effect = "indirect",
                   estimator = "onestep")
summary(os_ie)
```

[TO FILL IN]

```{r ie_tmle, eval=FALSE, message=FALSE, warning=FALSE}
# compute targeted minimum loss estimate of the interventional indirect effect
tmle_ie <- medoutcon(W = example_data[, ..w_names],
                     A = example_data$A,
                     Z = example_data$Z,
                     M = example_data[, ..m_names],
                     Y = example_data$Y,
                     effect = "indirect",
                     estimator = "tmle")
summary(tmle_ie)
```

[TO FILL IN]

## References

